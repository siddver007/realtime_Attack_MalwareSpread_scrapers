import websocket
import json
from datetime import datetime

def getUTCTimestamp():
    return datetime.utcnow()

def doDump():
    prevDate = getUTCTimestamp().date()
    f = open('attack_dump_' + str(prevDate) + '.csv', 'a')
    ws = websocket.create_connection("ws://map.norsecorp.com/socketcluster/")
    ws.send('{"event":"#handshake","data":{"authToken":null},"cid":1}')
    ws.send('{"event":"#subscribe","data":{"channel":"global"},"cid":2}')
    ws.recv()

    count = 0
    try:
        while ws.connected:
            try:
                result =  ws.recv()
                if result == "#1":
                    if count == 1:
                        doDump()
                    ws.send("#2")
                else:
                    dump = json.loads(result)
                    data = dump['data']['data'][0]
                    timestamp = getUTCTimestamp()
                    # attacker_ip , attacker_lat , attacker_long , target_lat , target_long , timestamp (UTC)
                    data_string = (data['md5'] + " , " + str(data['latitude']) + " , " + str(data['longitude']) +
                        " , " + str(data['latitude2']) + " , " + str(data['longitude2']) + " , " + str(getUTCTimestamp()))
                    if timestamp.date() > prevDate:
                        f.close()
                        f = open('attack_dump_' + str(timestamp.date()) + '.csv', 'a')
                        prevDate = timestamp.date()
                    f.write(data_string + "\n")
                    print(data_string)
                    count = 2
            except Exception as e:
                count = 1
                pass
    finally:
        print('Closing file...')
        f.close() 
                
if __name__ == "__main__":
    while True:
        try:
            doDump()
        except:
            pass
