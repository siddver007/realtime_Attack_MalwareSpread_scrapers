import websocket
import json
from datetime import datetime

def getUTCTimestamp():
    return datetime.utcnow()

def doDump():
    prevDate = getUTCTimestamp().date()
    f = open('malware_dump_' + str(prevDate) + '.csv', 'a')
    ws = websocket.create_connection("wss://trace.malwarebytes.com/socketcluster/")
    ws.send('{"event":"#handshake","data":{"authToken":null},"cid":1}')
    ws.send('{"event":"#subscribe","data":{"channel":"detections"},"cid":2}')
    ws.recv()

    count = 0
    try:
        while ws.connected:
            try:
                result =  ws.recv()
                if result == "#1":
                    if count == 1:
                        doDump()
                    ws.send("#2")
                else:
                    dump = json.loads(result)
                    data = json.loads(dump['data']['data'])
                    timestamp = getUTCTimestamp()
                    # malware , lat , long , timestamp (UTC)
                    data_string = (str(data['malware_mvp']) + " , " + str(data['lat']) +
                        " , " + str(data['lng']) + " , " + str(timestamp))
                    if timestamp.date() > prevDate:
                        f.close()
                        f = open('malware_dump_' + str(timestamp.date()) + '.csv', 'a')
                        prevDate = timestamp.date()
                    f.write(data_string + "\n")
                    f.flush()
                    print(data_string)
                    count = 2
            except Exception as e:
                count = 1
                pass
    finally:
        print('Closing file...')
        f.close()                

if __name__ == "__main__":
    while True:
        try:
            doDump()
        except:
            pass

